"""
Auto-Insight Platform - Main Application
AI ê¸°ë°˜ ìë™ ë°ì´í„° ë¶„ì„ ë° ë¦¬í¬íŠ¸ ìƒì„± ì‹œìŠ¤í…œ
"""

import streamlit as st
import pandas as pd
import yaml
from pathlib import Path
import os
from dotenv import load_dotenv

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="Auto-Insight Platform",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ì»¤ìŠ¤í…€ CSS - ë‹¤í¬ í…Œë§ˆ
st.markdown("""
<style>
    /* ë©”ì¸ ë°°ê²½ - ë‹¤í¬ */
    .main {
        background: #0a0e27;
        background-image: 
            radial-gradient(at 47% 33%, hsl(240, 70%, 15%) 0, transparent 59%), 
            radial-gradient(at 82% 65%, hsl(260, 50%, 20%) 0, transparent 55%);
        background-attachment: fixed;
    }
    
    /* ì»¨í…ì¸  ì˜ì—­ - ë‹¤í¬ ì¹´ë“œ */
    .block-container {
        padding-top: 2rem;
        padding-bottom: 2rem;
        background: rgba(20, 25, 45, 0.95);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        margin: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* ì œëª© ìŠ¤íƒ€ì¼ - ë„¤ì˜¨ íš¨ê³¼ */
    h1 {
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 50%, #f093fb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        font-size: 3.5em !important;
        text-align: center;
        margin-bottom: 0.5rem;
        animation: fadeInDown 0.8s ease-out;
        text-shadow: 0 0 30px rgba(79, 172, 254, 0.5);
    }
    
    h2 {
        color: #00f2fe;
        font-weight: 700;
        border-left: 5px solid #00f2fe;
        padding-left: 15px;
        margin-top: 2rem;
        animation: fadeInLeft 0.6s ease-out;
        text-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
    }
    
    h3 {
        color: #4facfe;
        font-weight: 600;
    }
    
    /* ì¼ë°˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
    p, label, .stMarkdown {
        color: rgba(255, 255, 255, 0.9) !important;
    }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ - ë„¤ì˜¨/ë¹„ë¹„ë“œ */
    .analysis-card {
        background: rgba(30, 35, 55, 0.8);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        border: 2px solid transparent;
    }
    
    .analysis-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(79, 172, 254, 0.5);
        border: 2px solid #4facfe;
    }
    
    .card-ecommerce {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        border: 2px solid rgba(118, 75, 162, 0.4);
    }
    
    .card-ecommerce:hover {
        box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
        border: 2px solid #764ba2;
    }
    
    .card-sales {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(74, 85, 104, 0.3);
        border: 2px solid rgba(45, 55, 72, 0.4);
    }
    
    .card-sales:hover {
        box-shadow: 0 12px 40px rgba(74, 85, 104, 0.5);
        border: 2px solid #4a5568;
    }
    
    .card-review {
        background: linear-gradient(135deg, #2c5282 0%, #2a4365 100%);
        color: white;
        box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
        border: 2px solid rgba(42, 67, 101, 0.4);
    }
    
    .card-review:hover {
        box-shadow: 0 12px 40px rgba(44, 82, 130, 0.5);
        border: 2px solid #2c5282;
    }
    
    /* ë©”íŠ¸ë¦­ ì¹´ë“œ - ë‹¤í¬ + ë„¤ì˜¨ */
    .metric-card {
        background: rgba(30, 35, 55, 0.9);
        padding: 25px 20px;  /* ìƒí•˜ íŒ¨ë”© ì¦ê°€ */
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(79, 172, 254, 0.3);
        min-height: 140px;  /* ìµœì†Œ ë†’ì´ ê³ ì • */
        height: 140px;  /* ë†’ì´ ê³ ì • */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .metric-card:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(79, 172, 254, 0.5);
        border: 1px solid #4facfe;
    }
    
    .metric-value {
        font-size: 2.5em;
        font-weight: 800;
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 10px 0;
        text-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
        line-height: 1.2;  /* ì¤„ ë†’ì´ ì¡°ì • */
    }
    
    .metric-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95em;  /* ê¸€ì í¬ê¸° ì•½ê°„ ì¦ê°€ */
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
        margin-bottom: 8px;  /* í•˜ë‹¨ ì—¬ë°± */
    }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ - ë„¤ì˜¨ íš¨ê³¼ */
    .stButton > button {
        width: 100%;
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1.1em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.6);
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(79, 172, 254, 0.8);
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    /* ì‚¬ì´ë“œë°” - ë‹¤í¬ ê·¸ë¼ë°ì´ì…˜ */
    .css-1d391kg, [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #1a1f3a 0%, #0a0e27 100%);
        border-right: 1px solid rgba(79, 172, 254, 0.2);
    }
    
    .css-1d391kg h1, .css-1d391kg h2, .css-1d391kg h3, 
    [data-testid="stSidebar"] h1, [data-testid="stSidebar"] h2, [data-testid="stSidebar"] h3 {
        color: white !important;
        -webkit-text-fill-color: white !important;
    }
    
    .css-1d391kg .stMarkdown, [data-testid="stSidebar"] .stMarkdown {
        color: rgba(255, 255, 255, 0.9);
    }
    
    /* ì§„í–‰ ë‹¨ê³„ ìŠ¤íƒ€ì¼ - ë„¤ì˜¨ */
    .step-active {
        color: #00f2fe;
        font-weight: 700;
        font-size: 1.1em;
        text-shadow: 0 0 10px rgba(0, 242, 254, 0.5);
    }
    
    .step-complete {
        color: #43e97b;
        text-shadow: 0 0 5px rgba(67, 233, 123, 0.3);
    }
    
    .step-pending {
        color: rgba(255, 255, 255, 0.4);
    }
    
    /* íŒŒì¼ ì—…ë¡œë” - ë‹¤í¬ */
    .uploadedFile {
        border: 2px dashed #4facfe;
        border-radius: 10px;
        padding: 20px;
        background: rgba(30, 35, 55, 0.5);
    }
    
    /* ë°ì´í„°í”„ë ˆì„ - ë‹¤í¬ */
    .dataframe {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        background: rgba(30, 35, 55, 0.9);
        color: white;
    }
    
    /* ì •ë³´ ë°•ìŠ¤ - ë‹¤í¬ */
    .stAlert {
        border-radius: 10px;
        border-left: 5px solid #4facfe;
        background: rgba(30, 35, 55, 0.9);
        color: white;
    }
    
    /* íƒ­ ìŠ¤íƒ€ì¼ - ë‹¤í¬ */
    .stTabs [data-baseweb="tab-list"] {
        gap: 10px;
        background: transparent;
    }
    
    .stTabs [data-baseweb="tab"] {
        border-radius: 10px 10px 0 0;
        padding: 10px 20px;
        background-color: rgba(30, 35, 55, 0.7);
        border: 1px solid rgba(79, 172, 254, 0.3);
        color: rgba(255, 255, 255, 0.7);
    }
    
    .stTabs [aria-selected="true"] {
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
        color: white;
        border: 1px solid #4facfe;
        box-shadow: 0 3px 15px rgba(79, 172, 254, 0.5);
    }
    
    /* Expander - ë‹¤í¬ */
    .streamlit-expanderHeader {
        background: rgba(30, 35, 55, 0.9);
        color: white;
        border: 1px solid rgba(79, 172, 254, 0.3);
        border-radius: 5px;
    }
    
    /* ì…ë ¥ í•„ë“œ - ë‹¤í¬ */
    .stTextInput > div > div > input,
    .stSelectbox > div > div > select {
        background: rgba(30, 35, 55, 0.9);
        color: white;
        border: 1px solid rgba(79, 172, 254, 0.3);
    }
    
    /* Progress bar */
    .stProgress > div > div > div > div {
        background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
    }
    
    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
    
    @keyframes neonGlow {
        0%, 100% {
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        50% {
            text-shadow: 0 0 20px rgba(79, 172, 254, 0.8);
        }
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .stSpinner > div {
        border-top-color: #4facfe !important;
    }
    
    /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
    .stDownloadButton > button {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(67, 233, 123, 0.4);
    }
    
    .stDownloadButton > button:hover {
        box-shadow: 0 6px 25px rgba(67, 233, 123, 0.6);
    }
</style>
""", unsafe_allow_html=True)

# ì„¤ì • íŒŒì¼ ë¡œë“œ
@st.cache_data
def load_config():
    config_path = Path(__file__).parent / "config" / "settings.yaml"
    with open(config_path, 'r', encoding='utf-8') as f:
        return yaml.safe_load(f)

config = load_config()

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'analysis_type' not in st.session_state:
    st.session_state.analysis_type = None
if 'data' not in st.session_state:
    st.session_state.data = None
if 'analysis_complete' not in st.session_state:
    st.session_state.analysis_complete = False

# ì‚¬ì´ë“œë°”
with st.sidebar:
    st.markdown("""
        <div style='text-align: center; padding: 20px 0;'>
            <h1 style='font-size: 2.5em; margin: 0; color: white !important; -webkit-text-fill-color: white !important;'>ğŸ“Š</h1>
            <h2 style='color: white !important; -webkit-text-fill-color: white !important; margin: 10px 0;'>Auto-Insight</h2>
            <p style='color: rgba(255,255,255,0.8); font-size: 0.9em;'>AI ê¸°ë°˜ ë°ì´í„° ë¶„ì„</p>
        </div>
    """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    # ì§„í–‰ ë‹¨ê³„ í‘œì‹œ
    steps = {
        1: "ë¶„ì„ íƒ€ì… ì„ íƒ",
        2: "ë°ì´í„° ì—…ë¡œë“œ",
        3: "ë°ì´í„° ê²€ì¦",
        4: "ë¶„ì„ ì‹¤í–‰",
        5: "ê²°ê³¼ í™•ì¸"
    }
    
    current_step = 1
    if st.session_state.analysis_type:
        current_step = 2
    if st.session_state.data is not None:
        current_step = 3
    if st.session_state.analysis_complete:
        current_step = 5
    
    st.markdown("<h3 style='color: white !important; -webkit-text-fill-color: white !important;'>ğŸ“ ì§„í–‰ ë‹¨ê³„</h3>", unsafe_allow_html=True)
    
    for step_num, step_name in steps.items():
        if step_num == current_step:
            st.markdown(f"<p class='step-active'>â­ {step_num}. {step_name}</p>", unsafe_allow_html=True)
        elif step_num < current_step:
            st.markdown(f"<p class='step-complete'>âœ… {step_num}. {step_name}</p>", unsafe_allow_html=True)
        else:
            st.markdown(f"<p class='step-pending'>âšª {step_num}. {step_name}</p>", unsafe_allow_html=True)
    
    st.markdown("---")
    
    # ì´ˆê¸°í™” ë²„íŠ¼
    if st.button("ğŸ”„ ìƒˆë¡œ ì‹œì‘í•˜ê¸°", use_container_width=True):
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()
    
    st.markdown("---")
    
    st.markdown(f"""
        <div style='text-align: center; padding: 20px 0;'>
            <p style='color: rgba(255,255,255,0.6); font-size: 0.8em;'>Version {config['app']['version']}</p>
            <p style='color: rgba(255,255,255,0.6); font-size: 0.8em;'>Made with â¤ï¸</p>
        </div>
    """, unsafe_allow_html=True)

# ë©”ì¸ ì»¨í…ì¸ 
st.markdown("""
    <div style='text-align: center; padding: 20px 0;'>
        <h1>ğŸ¯ ìë™ ë°ì´í„° ë¶„ì„ í”Œë«í¼</h1>
        <p style='font-size: 1.3em; color: #666; margin-top: 10px;'>
            AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  <span style='color: #667eea; font-weight: 600;'>ì¸ì‚¬ì´íŠ¸</span>ë¥¼ ì œê³µí•©ë‹ˆë‹¤
        </p>
    </div>
""", unsafe_allow_html=True)

# Step 1: ë¶„ì„ íƒ€ì… ì„ íƒ
if st.session_state.analysis_type is None:
    st.markdown("---")
    st.markdown("<h2>1ï¸âƒ£ ë¶„ì„í•  ë°ì´í„° íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”</h2>", unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        <div class='analysis-card card-ecommerce'>
            <div style='text-align: center; font-size: 3em; margin-bottom: 15px;'>ğŸ›’</div>
            <h3 style='text-align: center; color: white; margin-bottom: 15px;'>E-commerce ë¶„ì„</h3>
            <p style='color: rgba(255,255,255,0.9); line-height: 1.6;'>
                <strong>ê³ ê° êµ¬ë§¤ ë°ì´í„° ë¶„ì„</strong><br><br>
                âœ“ RFM ë¶„ì„<br>
                âœ“ ê³ ê° ì„¸ë¶„í™”<br>
                âœ“ êµ¬ë§¤ íŒ¨í„´ ë°œê²¬<br><br>
                <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong><br>
                CustomerID, InvoiceDate,<br>
                Quantity, UnitPrice
            </p>
        </div>
        """, unsafe_allow_html=True)
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("E-commerce ì„ íƒ", key="ecommerce", use_container_width=True):
            st.session_state.analysis_type = "ecommerce"
            st.rerun()
    
    with col2:
        st.markdown("""
        <div class='analysis-card card-sales'>
            <div style='text-align: center; font-size: 3em; margin-bottom: 15px;'>ğŸ“ˆ</div>
            <h3 style='text-align: center; color: white; margin-bottom: 15px;'>ë§¤ì¶œ ë¶„ì„</h3>
            <p style='color: rgba(255,255,255,0.9); line-height: 1.6;'>
                <strong>íŒë§¤/ì¬ê³  ë°ì´í„° ë¶„ì„</strong><br><br>
                âœ“ ì‹œê³„ì—´ íŠ¸ë Œë“œ<br>
                âœ“ ìƒí’ˆë³„ ì„±ê³¼<br>
                âœ“ ABC ë¶„ì„<br><br>
                <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong><br>
                Date, Product,<br>
                Sales/Revenue
            </p>
        </div>
        """, unsafe_allow_html=True)
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("ë§¤ì¶œ ë¶„ì„ ì„ íƒ", key="sales", use_container_width=True):
            st.session_state.analysis_type = "sales"
            st.rerun()
    
    with col3:
        st.markdown("""
        <div class='analysis-card card-review'>
            <div style='text-align: center; font-size: 3em; margin-bottom: 15px;'>ğŸ’¬</div>
            <h3 style='text-align: center; color: white; margin-bottom: 15px;'>ë¦¬ë·° ë¶„ì„</h3>
            <p style='color: rgba(255,255,255,0.9); line-height: 1.6;'>
                <strong>í…ìŠ¤íŠ¸ ê°ì„± ë¶„ì„</strong><br><br>
                âœ“ ê°ì„± ë¶„ë¥˜<br>
                âœ“ í† í”½ ëª¨ë¸ë§<br>
                âœ“ í‚¤ì›Œë“œ ì¶”ì¶œ<br><br>
                <strong>í•„ìˆ˜ ì»¬ëŸ¼:</strong><br>
                Review/Text<br>
                Rating (ì„ íƒ)
            </p>
        </div>
        """, unsafe_allow_html=True)
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("ë¦¬ë·° ë¶„ì„ ì„ íƒ", key="review", use_container_width=True):
            st.session_state.analysis_type = "review"
            st.rerun()
    
    # ì•ˆë‚´ ë©”ì‹œì§€
    st.markdown("<br><br>", unsafe_allow_html=True)
    st.info("ğŸ’¡ **íŒ**: í¬ë¡¤ë§í•œ ë°ì´í„°ëŠ” `crawlers/` í´ë”ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. READMEë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.")

# Step 2: ë°ì´í„° ì—…ë¡œë“œ
elif st.session_state.data is None:
    st.markdown("---")
    
    # ì„ íƒëœ ë¶„ì„ íƒ€ì… í‘œì‹œ
    type_emoji = {"ecommerce": "ğŸ›’", "sales": "ğŸ“ˆ", "review": "ğŸ’¬"}
    type_names = {"ecommerce": "E-commerce", "sales": "ë§¤ì¶œ ë¶„ì„", "review": "ë¦¬ë·° ë¶„ì„"}
    
    st.markdown(f"""
        <div style='text-align: center; padding: 20px; 
                    background: linear-gradient(135deg, rgba(0, 242, 254, 0.15) 0%, rgba(79, 172, 254, 0.15) 100%);
                    border-radius: 15px; margin-bottom: 30px; border: 2px solid rgba(79, 172, 254, 0.3);'>
            <h2 style='color: #00f2fe !important; -webkit-text-fill-color: #00f2fe !important; margin: 0; 
                       text-shadow: 0 0 20px rgba(0, 242, 254, 0.5);'>
                {type_emoji[st.session_state.analysis_type]} {type_names[st.session_state.analysis_type]}
            </h2>
            <p style='color: rgba(255,255,255,0.8); margin-top: 10px; font-size: 1.1em;'>ë°ì´í„° íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        </div>
    """, unsafe_allow_html=True)
    
    # ë¶„ì„ íƒ€ì…ë³„ ì•ˆë‚´
    if st.session_state.analysis_type == "ecommerce":
        st.info("ğŸ›’ **E-commerce ë°ì´í„°**: CustomerID, InvoiceDate, Quantity, UnitPrice ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    elif st.session_state.analysis_type == "sales":
        st.info("ğŸ“ˆ **ë§¤ì¶œ ë°ì´í„°**: Date, Product, Sales/Revenue ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    elif st.session_state.analysis_type == "review":
        st.info("ğŸ’¬ **ë¦¬ë·° ë°ì´í„°**: Review/Text ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤. Rating, DateëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤.")
    
    st.markdown("<br>", unsafe_allow_html=True)
    
    # íŒŒì¼ ì—…ë¡œë”
    uploaded_file = st.file_uploader(
        "ğŸ“‚ CSV ë˜ëŠ” Excel íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”",
        type=['csv', 'xlsx', 'xls'],
        help=f"ìµœëŒ€ {config['upload']['max_file_size_mb']}MB"
    )
    
    if uploaded_file is not None:
        try:
            with st.spinner("ğŸ”„ íŒŒì¼ì„ ì½ëŠ” ì¤‘..."):
                # íŒŒì¼ íƒ€ì…ì— ë”°ë¼ ì½ê¸°
                if uploaded_file.name.endswith('.csv'):
                    # UTF-8 BOM ìë™ ì²˜ë¦¬
                    try:
                        df = pd.read_csv(uploaded_file, encoding='utf-8-sig')
                    except:
                        uploaded_file.seek(0)  # íŒŒì¼ í¬ì¸í„° ë¦¬ì…‹
                        df = pd.read_csv(uploaded_file, encoding='cp949')
                else:
                    df = pd.read_excel(uploaded_file)

                st.session_state.data = df
                st.success(f"âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! ({len(df):,}í–‰ x {len(df.columns)}ì—´)")
                st.balloons()
                st.rerun()

        except Exception as e:
            st.error(f"âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: {str(e)}")
            st.info("CSV íŒŒì¼ì˜ ì¸ì½”ë”©ì€ UTF-8 ë˜ëŠ” CP949ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.")

# Step 3: ë°ì´í„° ê²€ì¦ ë° ë¶„ì„
else:
    st.markdown("---")
    st.markdown("<h2>3ï¸âƒ£ ë°ì´í„° ê²€ì¦ ë° ë¯¸ë¦¬ë³´ê¸°</h2>", unsafe_allow_html=True)
    
    df = st.session_state.data
    
    # ë°ì´í„° ê°œìš” - ì˜ˆìœ ë©”íŠ¸ë¦­ ì¹´ë“œ
    st.markdown("<br>", unsafe_allow_html=True)
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.markdown(f"""
            <div class='metric-card'>
                <div class='metric-label'>ì´ í–‰ ìˆ˜</div>
                <div class='metric-value'>{len(df):,}</div>
            </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
            <div class='metric-card'>
                <div class='metric-label'>ì´ ì»¬ëŸ¼ ìˆ˜</div>
                <div class='metric-value'>{len(df.columns)}</div>
            </div>
        """, unsafe_allow_html=True)
    
    with col3:
        missing = df.isnull().sum().sum()
        st.markdown(f"""
            <div class='metric-card'>
                <div class='metric-label'>ê²°ì¸¡ì¹˜</div>
                <div class='metric-value' style='color: {"#f5576c" if missing > 0 else "#43e97b"};'>{missing:,}</div>
            </div>
        """, unsafe_allow_html=True)
    
    with col4:
        duplicates = df.duplicated().sum()
        st.markdown(f"""
            <div class='metric-card'>
                <div class='metric-label'>ì¤‘ë³µ í–‰</div>
                <div class='metric-value' style='color: {"#f5576c" if duplicates > 0 else "#43e97b"};'>{duplicates:,}</div>
            </div>
        """, unsafe_allow_html=True)
    
    st.markdown("<br><br>", unsafe_allow_html=True)
    
    # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°
    st.markdown("<h3>ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 10í–‰)</h3>", unsafe_allow_html=True)
    st.dataframe(df.head(10), use_container_width=True, height=400)
    
    # ì»¬ëŸ¼ ì •ë³´
    with st.expander("ğŸ” ì»¬ëŸ¼ ìƒì„¸ ì •ë³´", expanded=False):
        col_info = pd.DataFrame({
            'ì»¬ëŸ¼ëª…': df.columns,
            'ë°ì´í„° íƒ€ì…': df.dtypes.astype(str),
            'ê²°ì¸¡ì¹˜ ìˆ˜': df.isnull().sum(),
            'ê²°ì¸¡ì¹˜ ë¹„ìœ¨': (df.isnull().sum() / len(df) * 100).round(2).astype(str) + '%',
            'ê³ ìœ ê°’ ìˆ˜': df.nunique()
        })
        st.dataframe(col_info, use_container_width=True)
    
    st.markdown("---")

    # ë¶„ì„ ì‹¤í–‰ ë²„íŠ¼ (ë¶„ì„ì´ ì™„ë£Œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í‘œì‹œ)
    if not st.session_state.get('analysis_complete', False):
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            if st.button("ğŸš€ ë¶„ì„ ì‹œì‘í•˜ê¸°", type="primary", use_container_width=True):
                with st.spinner("ğŸ”® AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                    import time
                    time.sleep(1)  # ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼

                    try:
                        # ë¶„ì„ íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ ë¶„ì„ ìˆ˜í–‰
                        if st.session_state.analysis_type == "ecommerce":
                            # E-commerce RFM ë¶„ì„ ì‹¤í–‰
                            from modules.preprocessor import DataPreprocessor
                            from modules.rfm_analyzer import RFMAnalyzer
                            from modules.visualizer import Visualizer
                            from modules.insight_generator import InsightGenerator

                            st.success("âœ… E-commerce ë¶„ì„ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")

                            # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                            required_cols = ['customerid', 'invoicedate', 'quantity', 'unitprice']
                            df_cols_lower = [col.lower() for col in df.columns]

                            missing_cols = [col for col in required_cols if col not in df_cols_lower]

                            if missing_cols:
                                st.error(f"âŒ í•„ìˆ˜ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤: {', '.join(missing_cols)}")
                                st.info("ğŸ’¡ í•„ìš”í•œ ì»¬ëŸ¼: CustomerID, InvoiceDate, Quantity, UnitPrice")
                            else:
                                # Progress bar
                                progress_bar = st.progress(0)
                                status_text = st.empty()

                                # 1. ì „ì²˜ë¦¬ (normalize_column_namesê°€ ì†Œë¬¸ìë¡œ ë³€í™˜)
                                status_text.text("1/5 ë°ì´í„° ì „ì²˜ë¦¬ ì¤‘...")
                                progress_bar.progress(20)
                                preprocessor = DataPreprocessor(df)
                            processed_df, logs = (preprocessor
                                                 .normalize_column_names()
                                                 .handle_missing_values(strategy='drop')
                                                 .remove_duplicates()
                                                 .convert_date_columns(['invoicedate'])
                                                 .get_processed_data())
                            
                            # 2. RFM ë¶„ì„
                            status_text.text("2/5 RFM ë¶„ì„ ì¤‘...")
                            progress_bar.progress(40)
                            rfm_analyzer = RFMAnalyzer(
                                processed_df,
                                customer_col='customerid',  # ì†Œë¬¸ì
                                date_col='invoicedate',     # ì†Œë¬¸ì
                                amount_col=None,            # ìë™ ê³„ì‚°
                                quantity_col='quantity',    # ì†Œë¬¸ì
                                price_col='unitprice'       # ì†Œë¬¸ì
                            )
                            rfm_df = rfm_analyzer.calculate_rfm()

                            # 3. êµ°ì§‘í™”
                            status_text.text("3/5 ê³ ê° ì„¸ë¶„í™” ì¤‘...")
                            progress_bar.progress(60)
                            optimal_k, metrics = rfm_analyzer.find_optimal_clusters()
                            clustered_df = rfm_analyzer.perform_clustering()
                            cluster_summary = rfm_analyzer.get_cluster_summary()

                            # Session stateì— ì €ì¥ (GPT ë¶„ì„ì„ ìœ„í•´)
                            st.session_state.rfm_df = rfm_df
                            st.session_state.cluster_summary = cluster_summary
                            st.session_state.clustered_df = clustered_df

                            # ë””ë²„ê¹…: ì €ì¥ í™•ì¸
                            print(f"[DEBUG] Session stateì— ì €ì¥ë¨:")
                            print(f"  - rfm_df: {len(rfm_df)} rows")
                            print(f"  - cluster_summary: {len(cluster_summary)} clusters")

                            # 4. ì‹œê°í™”
                            status_text.text("4/5 ì‹œê°í™” ìƒì„± ì¤‘...")
                            progress_bar.progress(80)
                            visualizer = Visualizer()

                            # 5. ì™„ë£Œ
                            progress_bar.progress(100)
                            status_text.text("âœ… ë¶„ì„ ì™„ë£Œ!")
                            time.sleep(0.5)
                            progress_bar.empty()
                            status_text.empty()

                            st.success("ğŸ‰ E-commerce ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                            
                            # === ê²°ê³¼ í‘œì‹œ ===
                            st.markdown("---")
                            st.markdown("<h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>", unsafe_allow_html=True)
                            
                            # ë©”íŠ¸ë¦­ ì¹´ë“œ
                            col1, col2, col3, col4 = st.columns(4)
                            with col1:
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>ì´ ê³ ê° ìˆ˜</div>
                                        <div class='metric-value'>{len(clustered_df):,}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col2:
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>êµ°ì§‘ ê°œìˆ˜</div>
                                        <div class='metric-value'>{optimal_k}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col3:
                                vip_count = len(clustered_df[clustered_df['cluster_name'].str.contains('VIP|ì¶©ì„±', na=False)])
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>VIP/ì¶©ì„± ê³ ê°</div>
                                        <div class='metric-value' style='color: #43e97b;'>{vip_count:,}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col4:
                                risk_count = len(clustered_df[clustered_df['cluster_name'].str.contains('ì´íƒˆ|íœ´ë©´', na=False)])
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>ì´íƒˆ ìœ„í—˜</div>
                                        <div class='metric-value' style='color: #f5576c;'>{risk_count:,}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            
                            st.markdown("<br>", unsafe_allow_html=True)

                            # ì‹œê°í™”
                            tab1, tab2, tab3, tab4 = st.tabs(["ğŸ”¥ RFM íˆíŠ¸ë§µ", "ğŸ’ ê³ ê° ê°€ì¹˜ í”¼ë¼ë¯¸ë“œ", "ğŸ“ˆ ìƒì„¸ í†µê³„", "ğŸ“‹ ë°ì´í„°"])

                            with tab1:
                                st.markdown("### RFM íˆíŠ¸ë§µ")
                                st.markdown("ê° ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ì˜ RFM ì ìˆ˜ë¥¼ ì •ê·œí™”í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.")
                                fig_heatmap = visualizer.plot_rfm_heatmap(cluster_summary)
                                st.plotly_chart(fig_heatmap, use_container_width=True)

                                st.markdown("### êµ°ì§‘ë³„ ì§€í‘œ")
                                fig_bar = visualizer.plot_cluster_bar_chart(cluster_summary)
                                st.plotly_chart(fig_bar, use_container_width=True)

                            with tab2:
                                st.markdown("### ê³ ê° ê°€ì¹˜ í”¼ë¼ë¯¸ë“œ")
                                st.markdown("ë§¤ì¶œ ê¸°ì—¬ë„ ê¸°ì¤€ìœ¼ë¡œ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ë¥¼ í”¼ë¼ë¯¸ë“œ í˜•íƒœë¡œ í‘œì‹œí•©ë‹ˆë‹¤.")
                                fig_pyramid = visualizer.plot_customer_value_pyramid(cluster_summary)
                                st.plotly_chart(fig_pyramid, use_container_width=True)

                                st.markdown("### êµ°ì§‘ë³„ ê³ ê° ë¶„í¬")
                                fig_pie = visualizer.plot_cluster_distribution_pie(cluster_summary)
                                st.plotly_chart(fig_pie, use_container_width=True)

                            with tab3:
                                st.markdown("### êµ°ì§‘ë³„ ìƒì„¸ í†µê³„")
                                st.dataframe(cluster_summary, use_container_width=True, height=400)

                            with tab4:
                                st.markdown("### ê³ ê° ì„¸ë¶„í™” ë°ì´í„°")
                                display_cols = ['customerid', 'recency', 'frequency', 'monetary', 'cluster', 'cluster_name']
                                display_cols = [col for col in display_cols if col in clustered_df.columns]
                                st.dataframe(clustered_df[display_cols], use_container_width=True, height=400)
                            
                            # ì¸ì‚¬ì´íŠ¸
                            st.markdown("---")
                            st.markdown("<h2>ğŸ’¡ ì¸ì‚¬ì´íŠ¸ ë° ì œì•ˆ</h2>", unsafe_allow_html=True)
                            
                            generator = InsightGenerator()
                            insights = generator.generate_rfm_insights(rfm_df, cluster_summary)
                            
                            col1, col2 = st.columns(2)
                            with col1:
                                st.markdown("### ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­")
                                for finding in insights['key_findings']:
                                    st.info(finding)
                            
                            with col2:
                                st.markdown("### ğŸ’¡ ì•¡ì…˜ ì•„ì´í…œ")
                                for action in insights['action_items']:
                                    st.warning(action)
                            
                            # ë‹¤ìš´ë¡œë“œ
                            st.markdown("---")
                            st.markdown("<h2>ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h2>", unsafe_allow_html=True)

                            col1, col2 = st.columns(2)
                            with col1:
                                csv = clustered_df.to_csv(index=False, encoding='utf-8-sig')
                                st.download_button(
                                    label="ğŸ“„ ê³ ê° ì„¸ë¶„í™” CSV ë‹¤ìš´ë¡œë“œ",
                                    data=csv,
                                    file_name=f"rfm_analysis_{pd.Timestamp.now().strftime('%Y%m%d')}.csv",
                                    mime="text/csv",
                                    use_container_width=True
                                )

                            with col2:
                                st.info("HTML ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.")

                            # GPT ì‹¬ì¸µ ë¶„ì„ (ë¶„ì„ì´ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ í‘œì‹œ)
                            print(f"[DEBUG] GPT ì„¹ì…˜ ì²´í¬:")
                            print(f"  - rfm_df in session_state: {'rfm_df' in st.session_state}")
                            print(f"  - cluster_summary in session_state: {'cluster_summary' in st.session_state}")

                            if 'rfm_df' in st.session_state and 'cluster_summary' in st.session_state:
                                print(f"[DEBUG] GPT ì„¹ì…˜ ì§„ì…!")
                                st.markdown("---")
                                st.markdown("<h2>ğŸ¤– AI ì‹¬ì¸µ ë¶„ì„</h2>", unsafe_allow_html=True)
                                st.markdown("GPT-4o-minië¥¼ í™œìš©í•œ ê³ ê¸‰ RFM ë¶„ì„ ë° ì „ëµ ì œì•ˆ")

                                # API í‚¤ ìë™ ë¡œë“œ
                                api_key = os.getenv("OPENAI_API_KEY")
                                print(f"[DEBUG] API Key loaded: {api_key[:20] if api_key else 'None'}...")

                                if not api_key:
                                    st.error("âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.")
                                else:
                                    # Session state ì´ˆê¸°í™”
                                    if 'gpt_rfm_insights' not in st.session_state:
                                        st.session_state.gpt_rfm_insights = None
                                    if 'gpt_segment_strategy' not in st.session_state:
                                        st.session_state.gpt_segment_strategy = None
                                    if 'gpt_revenue_simulation' not in st.session_state:
                                        st.session_state.gpt_revenue_simulation = None
                                    if 'gpt_portfolio_risk' not in st.session_state:
                                        st.session_state.gpt_portfolio_risk = None

                                    # 4ê°œ ë²„íŠ¼
                                    col1, col2, col3, col4 = st.columns(4)

                                    with col1:
                                        if st.button("ğŸ“Š RFM í•´ì„", use_container_width=True):
                                            print(f"[DEBUG] RFM í•´ì„ ë²„íŠ¼ í´ë¦­ë¨!")
                                            with st.spinner("ğŸ¤– GPTê°€ RFM ë¶„ì„ì„ í•´ì„í•˜ëŠ” ì¤‘..."):
                                                try:
                                                    print(f"[DEBUG] GPTAnalyzer ì„í¬íŠ¸ ì¤‘...")
                                                    from modules.gpt_analyzer import GPTAnalyzer
                                                    print(f"[DEBUG] GPTAnalyzer ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì¤‘...")
                                                    gpt = GPTAnalyzer(api_key=api_key)
                                                    print(f"[DEBUG] RFM ë¶„ì„ ì‹œì‘...")
                                                    st.session_state.gpt_rfm_insights = gpt.analyze_rfm_insights(
                                                        st.session_state.rfm_df,
                                                        st.session_state.cluster_summary
                                                    )
                                                    print(f"[DEBUG] RFM ë¶„ì„ ì™„ë£Œ! ê²°ê³¼ ê¸¸ì´: {len(st.session_state.gpt_rfm_insights)}")
                                                    st.rerun()
                                                except Exception as e:
                                                    print(f"[DEBUG] ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
                                                    import traceback
                                                    traceback.print_exc()
                                                    st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

                                    with col2:
                                        if st.button("ğŸ¯ ì „ëµ ì œì•ˆ", use_container_width=True):
                                            with st.spinner("ğŸ¤– GPTê°€ ì„¸ê·¸ë¨¼íŠ¸ë³„ ì „ëµì„ ìƒì„±í•˜ëŠ” ì¤‘..."):
                                                try:
                                                    from modules.gpt_analyzer import GPTAnalyzer
                                                    gpt = GPTAnalyzer(api_key=api_key)
                                                    st.session_state.gpt_segment_strategy = gpt.generate_segment_strategy(
                                                        st.session_state.cluster_summary
                                                    )
                                                    st.rerun()
                                                except Exception as e:
                                                    st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

                                    with col3:
                                        if st.button("ğŸ’° ë§¤ì¶œ ì‹œë®¬ë ˆì´ì…˜", use_container_width=True):
                                            with st.spinner("ğŸ¤– GPTê°€ ë§¤ì¶œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ì¤‘..."):
                                                try:
                                                    from modules.gpt_analyzer import GPTAnalyzer
                                                    gpt = GPTAnalyzer(api_key=api_key)
                                                    st.session_state.gpt_revenue_simulation = gpt.simulate_revenue_growth(
                                                        st.session_state.rfm_df,
                                                        st.session_state.cluster_summary
                                                    )
                                                    st.rerun()
                                                except Exception as e:
                                                    st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

                                    with col4:
                                        if st.button("âš ï¸ ë¦¬ìŠ¤í¬ ë¶„ì„", use_container_width=True):
                                            with st.spinner("ğŸ¤– GPTê°€ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘..."):
                                                try:
                                                    from modules.gpt_analyzer import GPTAnalyzer
                                                    gpt = GPTAnalyzer(api_key=api_key)
                                                    st.session_state.gpt_portfolio_risk = gpt.analyze_portfolio_risk(
                                                        st.session_state.rfm_df,
                                                        st.session_state.cluster_summary
                                                    )
                                                    st.rerun()
                                                except Exception as e:
                                                    st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")

                                    # ê²°ê³¼ í‘œì‹œ
                                    st.markdown("<br>", unsafe_allow_html=True)

                                    print(f"[DEBUG] ê²°ê³¼ í‘œì‹œ ì²´í¬:")
                                    print(f"  - gpt_rfm_insights: {st.session_state.get('gpt_rfm_insights', None) is not None}")
                                    print(f"  - gpt_segment_strategy: {st.session_state.get('gpt_segment_strategy', None) is not None}")
                                    print(f"  - gpt_revenue_simulation: {st.session_state.get('gpt_revenue_simulation', None) is not None}")
                                    print(f"  - gpt_portfolio_risk: {st.session_state.get('gpt_portfolio_risk', None) is not None}")

                                    if st.session_state.gpt_rfm_insights:
                                        print(f"[DEBUG] RFM í•´ì„ ê²°ê³¼ í‘œì‹œ ì¤‘...")
                                        with st.expander("ğŸ“Š RFM í•´ì„ ê²°ê³¼", expanded=True):
                                            st.markdown(st.session_state.gpt_rfm_insights)

                                    if st.session_state.gpt_segment_strategy:
                                        with st.expander("ğŸ¯ ì„¸ê·¸ë¨¼íŠ¸ ì „ëµ ì œì•ˆ", expanded=True):
                                            st.markdown(st.session_state.gpt_segment_strategy)

                                    if st.session_state.gpt_revenue_simulation:
                                        with st.expander("ğŸ’° ë§¤ì¶œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼", expanded=True):
                                            st.markdown(st.session_state.gpt_revenue_simulation)

                                    if st.session_state.gpt_portfolio_risk:
                                        with st.expander("âš ï¸ í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬ ë¶„ì„", expanded=True):
                                            st.markdown(st.session_state.gpt_portfolio_risk)

                            st.session_state.analysis_complete = True

                    elif st.session_state.analysis_type == "sales":
                        st.info("ğŸš§ ë§¤ì¶œ ë¶„ì„ ê¸°ëŠ¥ì€ Phase 3ì—ì„œ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.")
                    
                    elif st.session_state.analysis_type == "review":
                        # ë¦¬ë·° ë¶„ì„ ì‹¤í–‰! (Phase 2)
                        from modules.text_analyzer import TextAnalyzer
                        from modules.visualizer import Visualizer
                        from modules.insight_generator import InsightGenerator
                        
                        st.success("âœ… ë¦¬ë·° ë¶„ì„ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")
                        
                        # í…ìŠ¤íŠ¸ ì»¬ëŸ¼ ì°¾ê¸°
                        text_col = None
                        rating_col = None
                        
                        for col in df.columns:
                            col_lower = col.lower()
                            if 'review' in col_lower or 'text' in col_lower or 'comment' in col_lower:
                                text_col = col
                            if 'rating' in col_lower or 'score' in col_lower or 'point' in col_lower:
                                rating_col = col
                        
                        if not text_col:
                            st.error("âŒ ë¦¬ë·° í…ìŠ¤íŠ¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'review', 'text', 'comment' ì¤‘ í•˜ë‚˜ì˜ ì´ë¦„ì„ ì‚¬ìš©í•˜ì„¸ìš”.")
                        else:
                            st.info(f"ğŸ“ í…ìŠ¤íŠ¸ ì»¬ëŸ¼: **{text_col}**" + (f" | í‰ì  ì»¬ëŸ¼: **{rating_col}**" if rating_col else ""))
                            
                            # ë¶„ì„ ì‹¤í–‰
                            progress_bar = st.progress(0)
                            status_text = st.empty()
                            
                            # 1. í…ìŠ¤íŠ¸ ë¶„ì„ê¸° ì´ˆê¸°í™”
                            status_text.text("1/5 í…ìŠ¤íŠ¸ ë¶„ì„ê¸° ì´ˆê¸°í™” ì¤‘...")
                            progress_bar.progress(20)
                            analyzer = TextAnalyzer(df, text_column=text_col, rating_column=rating_col)
                            
                            # 2. ì „ì²˜ë¦¬
                            status_text.text("2/5 í…ìŠ¤íŠ¸ ì „ì²˜ë¦¬ ì¤‘...")
                            progress_bar.progress(40)
                            analyzer.preprocess_text()
                            
                            # 3. ê°ì„± ë¶„ì„
                            status_text.text("3/5 ê°ì„± ë¶„ì„ ì¤‘...")
                            progress_bar.progress(60)
                            analyzer.analyze_sentiment_simple()
                            
                            # 4. í‚¤ì›Œë“œ ì¶”ì¶œ
                            status_text.text("4/5 í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...")
                            progress_bar.progress(80)
                            keywords = analyzer.extract_keywords(top_n=20, by_sentiment=True)
                            
                            # 5. í† í”½ ëª¨ë¸ë§
                            status_text.text("5/5 í† í”½ ëª¨ë¸ë§ ì¤‘...")
                            progress_bar.progress(90)
                            topics = analyzer.extract_topics(n_topics=3, n_words=8)
                            
                            # ë‹¨ì–´ ë¹ˆë„
                            word_freq = analyzer.get_word_frequency(top_n=50)
                            
                            progress_bar.progress(100)
                            status_text.text("âœ… ë¶„ì„ ì™„ë£Œ!")
                            time.sleep(0.5)
                            progress_bar.empty()
                            status_text.empty()
                            
                            st.success("ğŸ‰ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                            
                            # === ê²°ê³¼ í‘œì‹œ ===
                            st.markdown("---")
                            st.markdown("<h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>", unsafe_allow_html=True)
                            
                            # ê°ì„± ìš”ì•½
                            sentiment_summary = analyzer.get_sentiment_summary()
                            
                            # ë©”íŠ¸ë¦­ ì¹´ë“œ
                            col1, col2, col3, col4 = st.columns(4)
                            with col1:
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>ì „ì²´ ë¦¬ë·°</div>
                                        <div class='metric-value'>{sentiment_summary['total_reviews']}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col2:
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>ê¸ì • ë¦¬ë·°</div>
                                        <div class='metric-value' style='color: #43e97b;'>{sentiment_summary['positive_ratio']:.1f}%</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col3:
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>ë¶€ì • ë¦¬ë·°</div>
                                        <div class='metric-value' style='color: #f5576c;'>{sentiment_summary['negative_ratio']:.1f}%</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            with col4:
                                avg_score = sentiment_summary['avg_sentiment_score']
                                st.markdown(f"""
                                    <div class='metric-card'>
                                        <div class='metric-label'>í‰ê·  ê°ì„± ì ìˆ˜</div>
                                        <div class='metric-value'>{avg_score:.2f}</div>
                                    </div>
                                """, unsafe_allow_html=True)
                            
                            st.markdown("<br>", unsafe_allow_html=True)
                            
                            # ì‹œê°í™”
                            visualizer = Visualizer()
                            
                            # íƒ­ìœ¼ë¡œ êµ¬ë¶„
                            tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“Š ê°ì„± ë¶„ì„", "ğŸ”‘ í‚¤ì›Œë“œ", "ğŸ“š í† í”½", "ğŸ“ˆ ë°ì´í„°"])
                            
                            with tab1:
                                st.markdown("### ê°ì„± ë¶„í¬")
                                fig1 = visualizer.plot_sentiment_distribution(analyzer.df)
                                st.plotly_chart(fig1, use_container_width=True)
                                
                                st.markdown("### ê°ì„± ì ìˆ˜ ë¶„í¬")
                                fig2 = visualizer.plot_sentiment_score_distribution(analyzer.df)
                                st.plotly_chart(fig2, use_container_width=True)
                            
                            with tab2:
                                st.markdown("### ì „ì²´ ì£¼ìš” í‚¤ì›Œë“œ")
                                if 'all' in keywords:
                                    fig3 = visualizer.plot_keyword_bar_chart(keywords, sentiment='all')
                                else:
                                    fig3 = visualizer.plot_keyword_bar_chart(keywords)
                                st.plotly_chart(fig3, use_container_width=True)
                                
                                if 'positive' in keywords and 'negative' in keywords:
                                    st.markdown("### ê¸ì • vs ë¶€ì • í‚¤ì›Œë“œ ë¹„êµ")
                                    fig4 = visualizer.plot_keywords_comparison(keywords)
                                    st.plotly_chart(fig4, use_container_width=True)
                                
                                st.markdown("### ë‹¨ì–´ ë¹ˆë„")
                                fig5 = visualizer.plot_word_cloud_data(word_freq)
                                st.plotly_chart(fig5, use_container_width=True)
                            
                            with tab3:
                                if topics:
                                    st.markdown("### ì£¼ìš” í† í”½")
                                    for topic_name, words in topics.items():
                                        st.markdown(f"**{topic_name}**: {', '.join(words)}")
                                    
                                    fig6 = visualizer.plot_topic_words(topics)
                                    st.plotly_chart(fig6, use_container_width=True)
                                else:
                                    st.info("í† í”½ì„ ì¶”ì¶œí•˜ê¸°ì— ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")
                            
                            with tab4:
                                st.markdown("### ë¶„ì„ ë°ì´í„°")
                                display_cols = [text_col, 'sentiment', 'sentiment_score']
                                if rating_col:
                                    display_cols.insert(1, rating_col)
                                st.dataframe(analyzer.df[display_cols], use_container_width=True, height=400)
                            
                            # ì¸ì‚¬ì´íŠ¸ ìƒì„±
                            st.markdown("---")
                            st.markdown("<h2>ğŸ’¡ ì¸ì‚¬ì´íŠ¸ ë° ì œì•ˆ</h2>", unsafe_allow_html=True)
                            
                            generator = InsightGenerator()
                            insights = generator.generate_text_analysis_insights(
                                analyzer.df, 
                                sentiment_summary, 
                                keywords
                            )
                            
                            col1, col2 = st.columns(2)
                            with col1:
                                st.markdown("### ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­")
                                for finding in insights['key_findings']:
                                    st.info(finding)
                            
                            with col2:
                                st.markdown("### ğŸ’¡ ì•¡ì…˜ ì•„ì´í…œ")
                                for action in insights['action_items']:
                                    st.warning(action)
                            
                            # === GPT ê³ ê¸‰ ë¶„ì„ ì„¹ì…˜ ===
                            st.markdown("---")
                            st.markdown("<h2>ğŸ¤– AI ê³ ê¸‰ ë¶„ì„ (GPT-4)</h2>", unsafe_allow_html=True)
                            
                            # GPT ë¶„ì„ ë²„íŠ¼ë“¤
                            st.markdown("<br>", unsafe_allow_html=True)
                            col1, col2, col3, col4 = st.columns(4)
                            
                            with col1:
                                if st.button("ğŸ“ ë¦¬ë·° ìš”ì•½", use_container_width=True):
                                    st.session_state.gpt_action = 'summary'
                            with col2:
                                if st.button("âš ï¸ ì´ìŠˆ ê°ì§€", use_container_width=True):
                                    st.session_state.gpt_action = 'issues'
                            with col3:
                                if st.button("ğŸ“Š ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜", use_container_width=True):
                                    st.session_state.gpt_action = 'categories'
                            with col4:
                                if st.button("ğŸ’ ì‹¬ì¸µ ì¸ì‚¬ì´íŠ¸", use_container_width=True):
                                    st.session_state.gpt_action = 'insights'
                            
                            # GPT ë¶„ì„ ì‹¤í–‰
                            if 'gpt_action' in st.session_state and st.session_state.gpt_action:
                                api_key = os.getenv("OPENAI_API_KEY")

                                if not api_key:
                                    st.error("âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.")
                                    st.session_state.gpt_action = None
                                else:
                                    try:
                                        from modules.gpt_analyzer import GPTAnalyzer
                                        
                                        gpt_analyzer = GPTAnalyzer(api_key=api_key, model="gpt-4o-mini")
                                        reviews_list = analyzer.df[text_col].dropna().tolist()
                                        
                                        st.markdown("---")
                                        
                                        action = st.session_state.gpt_action
                                        
                                        # ë¦¬ë·° ìš”ì•½
                                        if action == 'summary':
                                            with st.spinner("ğŸ¤– GPTê°€ ë¦¬ë·°ë¥¼ ìš”ì•½í•˜ëŠ” ì¤‘..."):
                                                summary = gpt_analyzer.generate_summary(reviews_list, max_reviews=50)
                                            
                                            st.markdown("### ğŸ“ AI ë¦¬ë·° ìš”ì•½")
                                            st.success(summary)
                                        
                                        # ì´ìŠˆ ê°ì§€
                                        elif action == 'issues':
                                            with st.spinner("ğŸ¤– GPTê°€ ì´ìŠˆë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘..."):
                                                issues = gpt_analyzer.detect_issues(reviews_list, max_reviews=50)
                                            
                                            st.markdown("### âš ï¸ ì£¼ìš” ì´ìŠˆ ê°ì§€")
                                            
                                            if issues.get('critical_issues'):
                                                st.markdown("#### ğŸš¨ ì‹¬ê°í•œ ì´ìŠˆ")
                                                for issue in issues['critical_issues']:
                                                    severity_color = {
                                                        'high': 'ğŸ”´',
                                                        'medium': 'ğŸŸ¡',
                                                        'low': 'ğŸŸ¢'
                                                    }
                                                    st.error(f"{severity_color.get(issue.get('severity', 'medium'), 'âšª')} **{issue.get('issue')}**\n\n{issue.get('description')}")
                                            
                                            if issues.get('positive_highlights'):
                                                st.markdown("#### âœ¨ ê¸ì •ì ì¸ íŠ¹ì§•")
                                                for highlight in issues['positive_highlights']:
                                                    st.success(f"âœ… {highlight}")
                                            
                                            if issues.get('recommendations'):
                                                st.markdown("#### ğŸ’¡ ê°œì„  ì œì•ˆ")
                                                for rec in issues['recommendations']:
                                                    st.info(f"ğŸ’¡ {rec}")
                                        
                                        # ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
                                        elif action == 'categories':
                                            with st.spinner("ğŸ¤– GPTê°€ ì¹´í…Œê³ ë¦¬ë¥¼ ë¶„ë¥˜í•˜ëŠ” ì¤‘..."):
                                                categories = gpt_analyzer.categorize_reviews(reviews_list, max_reviews=50)
                                            
                                            st.markdown("### ğŸ“Š ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜")
                                            
                                            if categories.get('categories'):
                                                # íŒŒì´ ì°¨íŠ¸ë¡œ ì‹œê°í™”
                                                import plotly.graph_objects as go
                                                
                                                cat_data = categories['categories']
                                                labels = list(cat_data.keys())
                                                values = [cat_data[k].get('percentage', 0) for k in labels]
                                                
                                                fig = go.Figure(data=[go.Pie(
                                                    labels=labels,
                                                    values=values,
                                                    hole=0.4,
                                                    textinfo='label+percent',
                                                    marker=dict(colors=['#667eea', '#4facfe', '#43e97b', '#f5576c', '#ffd700', '#ff6b6b'])
                                                )])
                                                
                                                fig.update_layout(
                                                    title='ë¦¬ë·° ì¹´í…Œê³ ë¦¬ ë¶„í¬',
                                                    height=500
                                                )
                                                
                                                st.plotly_chart(fig, use_container_width=True)
                                                
                                                # ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œ
                                                st.markdown("#### ğŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì£¼ìš” í‚¤ì›Œë“œ")
                                                for cat, data in cat_data.items():
                                                    keywords_text = ", ".join(data.get('keywords', [])[:5])
                                                    st.markdown(f"**{cat}** ({data.get('percentage', 0)}%): {keywords_text}")
                                        
                                        # ì‹¬ì¸µ ì¸ì‚¬ì´íŠ¸
                                        elif action == 'insights':
                                            with st.spinner("ğŸ¤– GPTê°€ ì‹¬ì¸µ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘..."):
                                                insights_text = gpt_analyzer.generate_advanced_insights(
                                                    reviews_list, 
                                                    sentiment_summary,
                                                    max_reviews=50
                                                )
                                            
                                            st.markdown("### ğŸ’ AI ì‹¬ì¸µ ì¸ì‚¬ì´íŠ¸")
                                            st.markdown(f"""
                                                <div style='background: rgba(30, 35, 55, 0.9); 
                                                            padding: 20px; border-radius: 10px; 
                                                            border-left: 4px solid #00f2fe;
                                                            color: rgba(255, 255, 255, 0.9);'>
                                                    {insights_text.replace(chr(10), '<br>')}
                                                </div>
                                            """, unsafe_allow_html=True)
                                        
                                        # ë¶„ì„ ì™„ë£Œ í›„ ì•¡ì…˜ ì´ˆê¸°í™”
                                        st.session_state.gpt_action = None
                                    
                                    except ImportError:
                                        st.error("âŒ openai íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. `pip install openai`ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
                                        st.session_state.gpt_action = None
                                    except Exception as e:
                                        st.error(f"âŒ GPT ë¶„ì„ ì˜¤ë¥˜: {str(e)}")
                                        st.session_state.gpt_action = None
                            
                            # ë‹¤ìš´ë¡œë“œ ì„¹ì…˜
                            st.markdown("---")
                            st.markdown("<h2>ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</h2>", unsafe_allow_html=True)
                            
                            col1, col2 = st.columns(2)
                            with col1:
                                # CSV ë‹¤ìš´ë¡œë“œ
                                csv = analyzer.df.to_csv(index=False, encoding='utf-8-sig')
                                st.download_button(
                                    label="ğŸ“„ ë¶„ì„ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ",
                                    data=csv,
                                    file_name=f"review_analysis_{pd.Timestamp.now().strftime('%Y%m%d')}.csv",
                                    mime="text/csv",
                                    use_container_width=True
                                )
                            
                            with col2:
                                st.info("HTML ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ ì˜ˆì •ì…ë‹ˆë‹¤.")
                            
                            st.session_state.analysis_complete = True
                
                except Exception as e:
                    st.error(f"âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
                    st.exception(e)

# í‘¸í„°
st.markdown("<br><br>", unsafe_allow_html=True)
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; padding: 30px; 
                background: linear-gradient(135deg, rgba(0, 242, 254, 0.1) 0%, rgba(79, 172, 254, 0.1) 100%);
                border-radius: 15px; margin-top: 50px; border: 1px solid rgba(79, 172, 254, 0.3);'>
        <h3 style='background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%); 
                   -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
                   margin-bottom: 10px;'>Auto-Insight Platform</h3>
        <p style='color: rgba(255,255,255,0.8); margin: 0;'>
            Made with â¤ï¸ using Streamlit | AI ê¸°ë°˜ ìë™ ë°ì´í„° ë¶„ì„
        </p>
        <p style='color: rgba(255,255,255,0.6); font-size: 0.9em; margin-top: 10px;'>
            Â© 2024 Auto-Insight Team | Dark Theme Edition ğŸŒ™
        </p>
    </div>
    """,
    unsafe_allow_html=True
)
